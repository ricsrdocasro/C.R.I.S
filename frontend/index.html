<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>C.R.I.S. /// TERMINAL_ACCESS</title>
    <link id="favicon" rel="icon" href="Logo_Ordo_Realitas_Verde.png">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        /* --- VARIÁVEIS GERAIS --- */
        :root {
            --bg-color: #050505;
            --term-green: #00ff41; /* Verde Matrix (Padrão) */
            --term-dim: #008F11;
            
            /* Cores dos Elementos */
            --sangue: #ff3333;
            --morte: #a0a0a0;
            --conhecimento: #ffcc00;
            --energia: #bf00ff;
            --medo: #ffffff;
        }

        * { box-sizing: border-box; }
        
        /* --- SCROLLBAR CUSTOMIZADA --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #020202; border-left: 1px solid #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: var(--term-dim); border: 1px solid var(--bg-color); }
        ::-webkit-scrollbar-thumb:hover { background: var(--term-green); cursor: pointer; }
        ::-webkit-scrollbar-corner { background: #000; }
        * { scrollbar-width: thin; scrollbar-color: var(--term-dim) #000; }

        body {
            background-color: var(--bg-color);
            font-family: 'Fira Code', monospace;
            margin: 0; padding: 0;
            color: var(--term-green);
            height: 100dvh;
            overflow: hidden;
            display: flex; flex-direction: column;
            text-shadow: 0 0 4px var(--term-dim);
            transition: color 0.5s ease, text-shadow 0.5s ease;
        }

        /* --- OVERLAY DE INICIALIZAÇÃO --- */
        #init-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 99999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer;
        }
        #init-btn {
            border: 2px solid var(--term-green); color: var(--term-green);
            padding: 20px 40px; font-family: 'Share Tech Mono'; font-size: 1.5rem;
            background: transparent; text-transform: uppercase; letter-spacing: 3px;
            animation: pulse-btn 2s infinite;
        }
        @keyframes pulse-btn { 0% { box-shadow: 0 0 0 0 rgba(0, 255, 65, 0.4); } 70% { box-shadow: 0 0 0 20px rgba(0, 255, 65, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 255, 65, 0); } }

        /* --- SCANLINES --- */
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            z-index: 9000; pointer-events: none; opacity: 0.6;
        }

        /* --- TELA DE BOOT --- */
        #boot-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color);
            z-index: 5000;
            display: none; 
            align-items: flex-start; justify-content: flex-start;
            padding: 40px;
            font-size: 1.1rem;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        .cursor-blink::after { content: '█'; animation: blink 1s infinite; margin-left: 5px; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* --- LAYOUT PRINCIPAL --- */
        header {
            border-bottom: 1px solid var(--term-dim);
            padding: 10px 20px; background: #001100;
            display: flex; justify-content: space-between; align-items: center;
            height: 50px; flex-shrink: 0;
            z-index: 10;
        }
        
        main {
            flex: 1; display: flex; padding: 20px; gap: 20px;
            max-width: 1400px; margin: 0 auto; width: 100%; height: calc(100% - 50px); overflow: hidden;
            position: relative;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 280px; display: flex; flex-direction: column; flex-shrink: 0;
            border: 1px solid var(--term-dim);
            background: rgba(0, 20, 0, 0.2);
            transition: border-color 0.5s;
        }

        .logo-area {
            padding: 30px; 
            border-bottom: 1px solid var(--term-dim);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .cris-logo img {
            width: 120px; height: auto;
            filter: grayscale(100%) brightness(0.8) sepia(100%) hue-rotate(50deg) saturate(500%) drop-shadow(0 0 5px var(--term-green));
            opacity: 0.9; transition: all 0.5s;
        }
        .glitch-active img {
            animation: glitch-contained 3s infinite;
            will-change: clip-path, transform, filter;
        }

        .sys-version { margin-top: 10px; font-size: 0.7rem; letter-spacing: 2px; opacity: 0.7; }
        .sidebar-header { background: var(--term-dim); color: black; padding: 5px 10px; font-weight: bold; font-size: 0.8rem; transition: background 0.5s; }

        .history-list {
            flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 5px;
            scrollbar-width: thin; scrollbar-color: var(--term-dim) black;
        }

        .history-item {
            padding: 10px; border: 1px solid transparent; cursor: pointer;
            font-size: 0.8rem; display: flex; justify-content: space-between; align-items: center;
            color: rgba(0, 255, 65, 0.7); transition: 0.2s;
        }
        .history-item:hover { border-color: var(--term-green); background: rgba(0, 255, 0, 0.1); }
        .history-item.active { background: var(--term-green); color: black; font-weight: bold; }

        .delete-btn { font-family: sans-serif; font-weight: bold; padding: 0 5px; opacity: 0.5; }
        .delete-btn:hover { opacity: 1; color: #000; }

        .new-chat-btn {
            border-top: 1px solid var(--term-dim); padding: 15px;
            text-align: center; cursor: pointer; font-weight: bold; letter-spacing: 1px;
            transition: 0.3s;
        }
        .new-chat-btn:hover { background: var(--term-green); color: black; }

        /* --- CHAT AREA --- */
        .chat-interface {
            flex: 1; border: 1px solid var(--term-dim);
            display: flex; flex-direction: column; position: relative;
            background: rgba(0, 10, 0, 0.4);
            box-shadow: inset 0 0 80px rgba(0,0,0,0.9);
            transition: border-color 0.5s;
            overflow: hidden;
        }

        .messages-area {
            flex: 1; padding: 30px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 20px;
            font-family: 'Share Tech Mono', monospace;
        }

        .message {
            max-width: 90%; line-height: 1.5; font-size: 1rem; 
            padding-left: 15px; border-left: 2px solid transparent;
            word-wrap: break-word;
        }
        
        .message.user { align-self: flex-start; color: #aaa; border-left-color: #555; }
        .message.user::before { content: "> AGENTE: "; color: white; font-weight: bold; }
        
        .message.bot { align-self: flex-start; color: var(--term-green); border-left-color: var(--term-green); }
        .message.bot::before { content: "[C.R.I.S]: "; font-weight: bold; }

        /* Classes para Cores de Elementos */
        .element-sangue { color: var(--sangue) !important; text-shadow: 0 0 8px var(--sangue); font-weight: bold; }
        .element-morte { color: var(--morte) !important; text-shadow: 0 0 8px var(--morte); font-weight: bold; }
        .element-conhecimento { color: var(--conhecimento) !important; text-shadow: 0 0 8px var(--conhecimento); font-weight: bold; }
        .element-energia { color: var(--energia) !important; text-shadow: 0 0 8px var(--energia); font-weight: bold; }
        .element-medo { color: var(--medo) !important; text-shadow: 0 0 10px #fff; font-weight: bold; animation: text-glitch 0.2s infinite; }

        @keyframes text-glitch { 0% { opacity: 1; } 50% { opacity: 0.7; transform: skewX(10deg); } 100% { opacity: 1; } }

        .message b { color: white; text-shadow: 0 0 5px white; }
        .message i { color: inherit; font-style: italic; opacity: 0.8; }

        /* --- INPUT --- */
        .input-area {
            border-top: 1px solid var(--term-dim); padding: 15px;
            display: flex; gap: 10px; background: #000;
            flex-shrink: 0;
        }
        .prompt-symbol { padding: 10px 0 10px 5px; font-weight: bold; font-size: 1.2rem; }

        input {
            flex: 1; background: transparent; border: none;
            color: var(--term-green); font-family: 'Fira Code', monospace; font-size: 1rem;
            outline: none;
        }
        input::placeholder { color: rgba(0, 255, 65, 0.3); }

        button#send-btn {
            background: transparent; border: 1px solid var(--term-green);
            color: var(--term-green); padding: 0 30px; cursor: pointer;
            font-family: 'Share Tech Mono'; font-weight: bold; transition: all 0.2s;
        }
        button#send-btn:hover { background: var(--term-green); color: black; box-shadow: 0 0 10px var(--term-green); }
        button#send-btn:disabled { border-color: #333; color: #333; cursor: not-allowed; box-shadow: none; }

        /* --- KEYFRAMES GLITCH --- */
        @keyframes glitch-contained {
            0% { clip-path: inset(0 0 0 0); transform: translate(0); filter: grayscale(100%) brightness(0.8) sepia(100%) hue-rotate(50deg) saturate(500%); }
            2% { clip-path: inset(10% 0 85% 0); transform: translate(-5px, 0); filter: grayscale(100%) brightness(0.8) sepia(100%) hue-rotate(50deg) saturate(500%) drop-shadow(5px 0 0 rgba(0, 255, 255, 0.5)); }
            4% { clip-path: inset(60% 0 30% 0); transform: translate(8px, 0); filter: grayscale(100%) brightness(0.8) sepia(100%) hue-rotate(50deg) saturate(500%) drop-shadow(-5px 0 0 rgba(255, 0, 0, 0.5)); }
            6% { clip-path: inset(20% 0 60% 0); transform: translate(-3px, 0); }
            8% { clip-path: inset(0 0 0 0); transform: translate(0); filter: grayscale(100%) brightness(0.8) sepia(100%) hue-rotate(50deg) saturate(500%); }
            100% { clip-path: inset(0 0 0 0); transform: translate(0); }
        }

        /* --- SHUTDOWN --- */
        @keyframes turn-off {
            0% { transform: scale(1, 1.3) translate3d(0, 0, 0); filter: brightness(1); opacity: 1; }
            60% { transform: scale(1, 0.001) translate3d(0, 0, 0); filter: brightness(10); }
            100% { animation-timing-function: cubic-bezier(0.755, 0.05, 0.855, 0.06); transform: scale(0, 0.001) translate3d(0, 0, 0); filter: brightness(0); opacity: 0; }
        }
        .shutdown-mode {
            animation: turn-off 0.55s cubic-bezier(0.23, 1, 0.32, 1);
            animation-fill-mode: forwards;
        }

        /* --- ASCII ART --- */
        .ascii-art {
            font-family: 'Fira Code', 'Courier New', monospace;
            white-space: pre; font-size: 8px; line-height: 8px;
            color: inherit; margin: 10px 0; overflow-x: auto;
            width: 100%; display: block; text-align: center;
        }
        @media (max-width: 600px) { .ascii-art { font-size: 4px; line-height: 4px; } }

        /* --- TOOLTIP FLUTUANTE --- */
        .tooltip-box {
            position: fixed;
            display: none; 
            background: rgba(0, 15, 0, 0.95);
            border: 1px solid var(--term-green);
            color: var(--term-green);
            padding: 10px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.8rem;
            max-width: 250px;
            z-index: 10000;
            pointer-events: none;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(2px);
        }
        .tooltip-title {
            font-weight: bold;
            border-bottom: 1px solid #333;
            margin-bottom: 5px;
            padding-bottom: 2px;
            text-transform: uppercase;
            color: #fff;
        }
        .has-tooltip {
            cursor: help;
            text-decoration: underline dotted rgba(255, 255, 255, 0.3);
        }

        /* =================================================================
           LAYOUT MOBILE RESPONSIVO
           ================================================================= */
        #mobile-menu-btn { display: none; }

        @media (max-width: 800px) {
            main { padding: 10px; width: 100vw; }
            header { padding-left: 60px; font-size: 0.9rem; }

            #mobile-menu-btn {
                display: block; position: fixed; top: 10px; left: 10px;
                z-index: 2000; background: black; border: 1px solid var(--term-green);
                color: var(--term-green); padding: 5px 10px;
                font-family: 'Fira Code'; cursor: pointer; font-weight: bold;
            }

            .sidebar {
                position: fixed; top: 0; left: -110%; width: 85%; height: 100%;
                background: #000; z-index: 3000;
                border-right: 2px solid var(--term-green);
                box-shadow: 100px 0 100px rgba(0,0,0,0.8);
                transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            .sidebar.active { left: 0; }
            .input-area { padding: 10px; }
            input { font-size: 16px; }
            button#send-btn { padding: 0 15px; font-size: 1.2rem; }
        }
    </style>
</head>
<body>

    <button id="mobile-menu-btn" onclick="toggleSidebar()">☰ MENU</button>
    <div id="menu-overlay" onclick="toggleSidebar()" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:2500; background:rgba(0,0,0,0.5);"></div>

    <div class="scanlines"></div>

    <div id="init-overlay">
        <div id="init-btn">INICIALIZAR SISTEMA</div>
        <div style="margin-top: 20px; color: #00ff41; font-family: 'Fira Code'; font-size: 0.8rem;">/// TOQUE PARA CONECTAR ///</div>
    </div>

    <div id="boot-screen">
        <div id="boot-text" class="cursor-blink"></div>
    </div>

    <header>
        <div>/// ORDO_REALITAS_SECURE_NET ///</div>
        <div id="clock">00:00:00</div>
    </header>

    <main id="main-interface" style="display:none;">
        <aside class="sidebar">
            <div class="logo-area">
                <div class="cris-logo">
                    <img src="Logo_Ordo_Realitas.webp" alt="Ordo Realitas">
                </div>
                <div class="sys-version">SYS. V.2.0.4</div>
            </div>

            <div class="sidebar-header">/// ARQUIVOS ///</div>
            <div class="history-list" id="history-list-dom"></div>
            <div class="new-chat-btn" onclick="startNewSession()">[+] NOVO PROTOCOLO</div>
            <div style="padding:10px; text-align:center; border-top:1px solid #004400; font-size:0.8rem; cursor:pointer;" onclick="toggleSidebar()" class="mobile-only-close">FECHAR MENU</div>
        </aside>

        <section class="chat-interface">
            <div class="messages-area" id="messages"></div>
            <div class="input-area">
                <span class="prompt-symbol">></span>
                <input type="text" id="user-input" placeholder="Aguardando input..." autocomplete="off">
                <button id="send-btn">ENVIAR</button>
            </div>
        </section>
    </main>

    <script>
        // =================================================================
        // CONFIGURAÇÃO DO SISTEMA & ESTADO
        // =================================================================
        const API_URL = "https://ricsrdocasro-c-r-i-s-backend.hf.space/chat"; 
        const startupAudio = new Audio('startup.mp3');
        startupAudio.volume = 0.5;

        // Recupera ou cria configuração do sistema
        let sysConfig = JSON.parse(localStorage.getItem('cris_sys_config_v1')) || { 
            status: 'shutdown', // 'shutdown' ou 'active'
            seenBoot: false,    // true se já viu a intro completa
            username: null
        };

        function saveSysConfig() {
            localStorage.setItem('cris_sys_config_v1', JSON.stringify(sysConfig));
        }

        // =================================================================
        // ELEMENTOS DOM
        // =================================================================
        const EL = {
            input: document.getElementById('user-input'),
            btn: document.getElementById('send-btn'),
            msgs: document.getElementById('messages'),
            histList: document.getElementById('history-list-dom'),
            bootText: document.getElementById('boot-text'),
            mainInterface: document.getElementById('main-interface'),
            bootScreen: document.getElementById('boot-screen'),
            initOverlay: document.getElementById('init-overlay')
        };

        // =================================================================
        // CONTROLE DE INICIALIZAÇÃO (LÓGICA NOVA)
        // =================================================================
        
        window.onload = () => {
            if (sysConfig.status === 'active') {
                EL.initOverlay.style.display = 'none';
                EL.mainInterface.style.display = 'flex';
                renderHistoryList(); 

                // CORREÇÃO: Força o carregamento visual da sessão atual ao iniciar
                if (storageData.currentId && storageData.sessions[storageData.currentId]) {
                    switchToSession(storageData.currentId);
                }

                setTimeout(() => EL.msgs.scrollTop = EL.msgs.scrollHeight, 100);
            } else {
                EL.initOverlay.style.display = 'flex';
                EL.mainInterface.style.display = 'none';
            }
        };

        EL.initOverlay.addEventListener('click', () => {
            // Pergunta o nome na primeira vez
            if (!sysConfig.username) {
                let nameInput = prompt("IDENTIFICAÇÃO NECESSÁRIA.\nDIGITE SEU CODINOME:");
                if (nameInput && nameInput.trim() !== "") {
                    sysConfig.username = nameInput.trim().toUpperCase();
                } else {
                    sysConfig.username = "AGENTE_DESCONHECIDO";
                }
                saveSysConfig(); 
            }

            EL.initOverlay.style.display = 'none';
            EL.bootScreen.style.display = 'flex';
            startupAudio.play().catch(e => console.log("Erro áudio:", e));

            if (!sysConfig.seenBoot) {
                runFullBootSequence();
                sysConfig.seenBoot = true; 
            } else {
                runFastBoot();
            }
            
            sysConfig.status = 'active';
            saveSysConfig();
        });

        // =================================================================
        // SEQUÊNCIAS DE BOOT
        // =================================================================
        
        function runFullBootSequence() {
            const memState = calculateMembrane();
            const bootLines = [
                "INICIANDO SISTEMA...",
                "CARREGANDO KERNEL...",
                "ACESSANDO SENSORES DE REALIDADE...",
                `VERIFICANDO MEMBRANA... <span style="color:${memState.cor}; text-shadow:0 0 10px ${memState.cor}; font-weight:bold;">${memState.status}</span>.`,
                "DETECTANDO SINAIS DE RITUAIS...",
                "CONECTANDO AO SERVIDOR C.R.I.S...",
                `> USUÁRIO: ${sysConfig.username}`,
                "ACESSO AUTORIZADO.",
                "BEM-VINDO À ORDEM."
            ];

            let lineIndex = 0;
            let charIndex = 0;
            
            function typeLine() {
                if (lineIndex < bootLines.length) {
                    const currentLine = bootLines[lineIndex];
                    
                    if (currentLine.includes('<span')) {
                        const parts = currentLine.split('<span'); 
                        const prefix = parts[0]; 
                        const suffix = '<span' + parts[1]; 
                        
                        if (charIndex < prefix.length) {
                            EL.bootText.innerHTML += prefix.charAt(charIndex);
                            charIndex++;
                            setTimeout(typeLine, 20);
                            return; 
                        } else {
                            EL.bootText.innerHTML += suffix + "\n";
                            lineIndex++;
                            charIndex = 0;
                            setTimeout(typeLine, 300);
                            return;
                        }
                    } 
                    
                    if (charIndex < currentLine.length) {
                        EL.bootText.innerHTML += currentLine.charAt(charIndex);
                        charIndex++;
                        setTimeout(typeLine, 20);
                    } else {
                        EL.bootText.innerHTML += "\n";
                        lineIndex++;
                        charIndex = 0;
                        setTimeout(typeLine, 300);
                    }
                } else {
                    finishBoot();
                }
            }
            typeLine();
        }

        function runFastBoot() {
            EL.bootText.innerHTML = `REESTABELECENDO CONEXÃO SEGURA...<br>AUTENTICANDO ${sysConfig.username}...<br>ACESSO RESTAURADO.`;
            setTimeout(finishBoot, 1500); 
        }

        function finishBoot() {
            setTimeout(() => {
                EL.bootScreen.style.opacity = 0;
                EL.bootScreen.style.transition = "opacity 1s";
                stopStartupSound(); 
                setTimeout(() => {
                    EL.bootScreen.style.display = "none";
                    EL.mainInterface.style.display = "flex";
                    EL.bootScreen.style.opacity = 1; 
                    EL.bootText.innerHTML = "";
                }, 1000);
            }, 500);
        }

        // =================================================================
        // FUNÇÕES UTILITÁRIAS (SOM, SIDEBAR, RELÓGIO)
        // =================================================================
        function toggleSidebar() {
            const sb = document.querySelector('.sidebar');
            const ov = document.getElementById('menu-overlay');
            sb.classList.toggle('active');
            ov.style.display = sb.classList.contains('active') ? 'block' : 'none';
        }

        function stopStartupSound() {
            const fadeAudio = setInterval(() => {
                if (startupAudio.volume > 0.05) {
                    startupAudio.volume -= 0.05;
                } else {
                    clearInterval(fadeAudio);
                    startupAudio.pause();
                    startupAudio.currentTime = 0; 
                }
            }, 200);
        }

        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString('pt-BR');
        }, 1000);

        // =================================================================
        // LÓGICA DA MEMBRANA & TOOLTIPS
        // =================================================================
        function calculateMembrane() {
            const now = new Date();
            const hour = now.getHours();
            const minutes = now.getMinutes();
            const day = now.getDay(); 
            const date = now.getDate(); 

            const isWitchingHour = (hour === 3);
            const isNight = (hour >= 18 || hour < 6);
            const isFriday13 = (day === 5 && date === 13);
            
            let baseChance = Math.random(); 
            let logExtra = "Níveis de entropia padrão.";

            if (isFriday13) {
                baseChance += 0.5; logExtra = "ALERTA: DATA DE CONVERGÊNCIA OCULTA (SEXTA-13).";
            } else if (isWitchingHour) {
                baseChance += 0.4; logExtra = `HORA MORTA DETECTADA [03:${minutes < 10 ? '0'+minutes : minutes}]. BARREIRA NO LIMITE.`;
            } else if (isNight) {
                baseChance += 0.15; logExtra = "Ausência de luz solar favorece o afinamento.";
            }

            if (baseChance > 0.85) return { status: "ROMPIDA", cor: "#ff0000", msg: "PERIGO IMEDIATO. ENTIDADES MANIFESTANDO.", log: logExtra, danger: true };
            else if (baseChance > 0.6) return { status: "DANIFICADA", cor: "#ffaa00", msg: "Afinamento crítico. Prepare rituais.", log: logExtra, danger: false };
            else if (baseChance > 0.3) return { status: "ENFRAQUECIDA", cor: "#ffff00", msg: "Oscilações detectadas.", log: logExtra, danger: false };
            else return { status: "ESTÁVEL", cor: "#00ff41", msg: "Nenhuma perturbação local.", log: logExtra, danger: false };
        }

        // 1. Definição dos Dados (Palavras + Descrições baseadas na Lore)
        const loreDatabase = [
            { 
                words: ['sangue', 'ódio', 'dor', 'raiva', 'violência', 'diabo', 'sentimento', 'emoção', 'bestial', 'flagelo', 'rubra', 'carnificina', 'obsessão', 'fluxo'], 
                class: 'element-sangue',
                title: 'ENTIDADE DE SANGUE',
                desc: 'A entidade do sentimento. Busca a intensidade da dor, do amor e da obsessão. Tudo começa pelo sangue e termina nele. Se manifesta através de carne viva, bestialidade e brutalidade.'
            },
            { 
                words: ['morte', 'lodo', 'espiral', 'podridão', 'tempo', 'segundos', 'eterno', 'parasita', 'distorção', 'inevitável', 'cinzas'], 
                class: 'element-morte',
                title: 'ENTIDADE DE MORTE',
                desc: 'A entidade do Tempo. Representa os momentos vivenciados e o fim inevitável. Distorce a percepção temporal através de espirais e do lodo sagrado que consome a matéria.'
            },
            { 
                words: ['conhecimento', 'saber', 'verdade', 'sigilo', 'outro lado', 'razão', 'lógica', 'regras', 'escritura', 'ouro', 'dourado', 'ordem', 'história'], 
                class: 'element-conhecimento',
                title: 'ENTIDADE DE CONHECIMENTO',
                desc: 'A entidade da Consciência. A lógica que reescreve a realidade através de sigilos e regras. Busca o equilíbrio e a anulação do caos. Onde há ordem, há Conhecimento.'
            },
            { 
                words: ['energia', 'caos', 'transformação', 'impossível', 'energização', 'eletricidade', 'fogo', 'luz', 'calor', 'imprevisível', 'glitch', 'intangível'], 
                class: 'element-energia',
                title: 'ENTIDADE DE ENERGIA',
                desc: 'A entidade do Caos. O intangível que tudo transforma. Representada por luz, temperatura e vibração. A Energia não segue lógica, apenas a pura aleatoriedade da mudança.'
            },
            { 
                words: ['medo', 'kian', 'infinito', 'enigma', 'desconhecido', 'degolificada', 'membrana', 'calamidade', 'inexistente', 'paranormal'], 
                class: 'element-medo',
                title: 'O MEDO (ELEMENTO DE ELEMENTOS)',
                desc: 'O Infinito. A cola que une a Realidade e o Outro Lado. O enigma impossível de ser compreendido. Tudo o que é Paranormal nasce do Medo do desconhecido.'
            }
        ];

        function highlightKeywords(text) {
            const tLower = text.toLowerCase();
            const logoDiv = document.querySelector('.cris-logo');
            let triggerGlitch = false;
            if (tLower.includes('kian') || tLower.includes('medo') || tLower.includes('desconhecido')) triggerGlitch = true;
            if (logoDiv) {
                if(triggerGlitch) logoDiv.classList.add('glitch-active');
                else logoDiv.classList.remove('glitch-active');
            }

            let formattedText = text;
            loreDatabase.forEach(group => {
                group.words.forEach(word => {
                    // Regex ajustada: \b para inicio de palavra, [a-zA-ZÀ-ÿ]* para sufixos
                    const regex = new RegExp(`(<[^>]*>)|(\\b${word}[a-zA-ZÀ-ÿ]*)`, 'gi');
                    formattedText = formattedText.replace(regex, (match, tag, capturedWord) => {
                        if (tag) return tag;
                        if (capturedWord) return `<span class="${group.class} has-tooltip" data-title="${group.title}" data-desc="${group.desc}">${capturedWord}</span>`;
                        return match;
                    });
                });
            });
            return formattedText;
        }

        // TOOLTIP EVENTS
        const tooltipEl = document.createElement('div');
        tooltipEl.id = 'lore-tooltip';
        tooltipEl.className = 'tooltip-box';
        document.body.appendChild(tooltipEl);

        document.addEventListener('mouseover', function(e) {
            if (e.target.classList.contains('has-tooltip')) {
                const title = e.target.getAttribute('data-title');
                const desc = e.target.getAttribute('data-desc');
                tooltipEl.innerHTML = `<div class="tooltip-title">${title}</div><div>${desc}</div>`;
                tooltipEl.style.display = 'block';
                const color = window.getComputedStyle(e.target).color;
                tooltipEl.style.borderColor = color;
                tooltipEl.style.boxShadow = `0 0 10px ${color}`;
            }
        });
        document.addEventListener('mouseout', function(e) {
            if (e.target.classList.contains('has-tooltip')) tooltipEl.style.display = 'none';
        });
        document.addEventListener('mousemove', function(e) {
            if (tooltipEl.style.display === 'block') {
                let x = e.clientX + 15;
                let y = e.clientY + 15;
                if (x + 260 > window.innerWidth) x = e.clientX - 265; 
                if (y + 100 > window.innerHeight) y = e.clientY - 100; 
                tooltipEl.style.left = x + 'px';
                tooltipEl.style.top = y + 'px';
            }
        });

        // =================================================================
        // SPINNER CLI (LOADING)
        // =================================================================
        function showCliSpinner() {
            const div = document.createElement('div');
            div.className = 'message bot';
            div.style.opacity = '0.7'; 
            
            const spinner = document.createElement('span');
            spinner.style.fontWeight = 'bold';
            spinner.style.color = 'var(--term-green)';
            
            const text = document.createElement('span');
            text.innerText = " PROCESSANDO DADOS...";
            
            div.appendChild(spinner);
            div.appendChild(text);
            EL.msgs.appendChild(div);
            EL.msgs.scrollTop = EL.msgs.scrollHeight;

            const frames = ['|', '/', '-', '\\'];
            let i = 0;
            const intervalId = setInterval(() => {
                spinner.innerText = `[ ${frames[i]} ]`; 
                i = (i + 1) % frames.length;
            }, 100); 

            return function stopSpinner() {
                clearInterval(intervalId);
                if (div.parentNode) div.remove();
            };
        }

        // =================================================================
        // CHAT ENGINE
        // =================================================================
        let storageData = JSON.parse(localStorage.getItem('cris_db_v1')) || { currentId: Date.now(), sessions: {} };
        let currentSession = [];
        let charQueue = [];
        let isProcessingQueue = false;
        let activeTyperId = 0;

        function saveStorage() { localStorage.setItem('cris_db_v1', JSON.stringify(storageData)); }

        function renderHistoryList() {
            EL.histList.innerHTML = '';
            const ids = Object.keys(storageData.sessions).reverse();
            ids.forEach(id => {
                const session = storageData.sessions[id];
                const firstUserMsg = session.find(m => m.sender === 'user');
                const title = firstUserMsg ? firstUserMsg.text.substring(0, 18) + "..." : "Log " + new Date(parseInt(id)).toLocaleTimeString();
                
                const div = document.createElement('div');
                div.className = 'history-item';
                if (parseInt(id) === storageData.currentId) div.classList.add('active');
                
                div.innerHTML = `<span>${title}</span> <span class="delete-btn" onclick="deleteSession(event, ${id})">X</span>`;
                div.onclick = (e) => { 
                    if(!e.target.classList.contains('delete-btn')) {
                        switchToSession(parseInt(id));
                        if(window.innerWidth <= 800) toggleSidebar();
                    }
                };
                EL.histList.appendChild(div);
            });
        }

        function startNewSession() {
            const newId = Date.now();
            storageData.currentId = newId;
            storageData.sessions[newId] = [{ sender: 'bot', text: 'C.R.I.S online. Envie sua solicitação.' }];
            saveStorage();
            switchToSession(newId);
            if(window.innerWidth <= 800) toggleSidebar();
        }

        function switchToSession(id) {
            storageData.currentId = id;
            currentSession = storageData.sessions[id] || [];
            EL.msgs.innerHTML = '';
            currentSession.forEach(msg => renderMsgHTML(msg.text, msg.sender));
            renderHistoryList();
            setTimeout(() => EL.msgs.scrollTop = EL.msgs.scrollHeight, 100);
        }

        function deleteSession(e, id) {
            e.stopPropagation();
            if(!confirm("Deletar arquivo permanentemente?")) return;
            delete storageData.sessions[id];
            if (id === storageData.currentId) startNewSession();
            else { saveStorage(); renderHistoryList(); }
        }

        function formatText(text) {
            let processed = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                                .replace(/\*(.*?)\*/g, '<i>$1</i>')
                                .replace(/\n/g, '<br>');
            return highlightKeywords(processed);
        }

        function renderMsgHTML(text, sender) {
            const div = document.createElement('div');
            div.className = `message ${sender}`;
            const span = document.createElement('span');
            span.innerHTML = formatText(text);
            div.appendChild(span);
            EL.msgs.appendChild(div);
            EL.msgs.scrollTop = EL.msgs.scrollHeight;
            return span; 
        }

        function processQueue(targetSpan, fullTextObj, typerId) {
            if (typerId !== activeTyperId) return;
            if (charQueue.length > 0) {
                isProcessingQueue = true;
                fullTextObj.val += charQueue.shift();
                targetSpan.innerHTML = formatText(fullTextObj.val);
                EL.msgs.scrollTop = EL.msgs.scrollHeight;
                setTimeout(() => processQueue(targetSpan, fullTextObj, typerId), 15);
            } else {
                isProcessingQueue = false;
                const lastMsg = currentSession[currentSession.length - 1];
                if (!lastMsg || lastMsg.text !== fullTextObj.val) {
                    currentSession.push({ sender: 'bot', text: fullTextObj.val });
                    saveStorage();
                }
                toggleInput(true);
            }
        }

        function toggleInput(enabled) {
            EL.input.disabled = !enabled;
            EL.btn.disabled = !enabled;
            if(enabled) {
                EL.input.focus();
                EL.btn.innerText = "ENVIAR";
            } else {
                EL.btn.innerText = "...";
            }
        }

        async function handleSend() {
            const text = EL.input.value.trim();
            if (!text) return;
            const lowerText = text.toLowerCase();

            // --- COMANDOS ESPECIAIS ---
            if (lowerText === '/clear') {
                EL.msgs.innerHTML = ''; currentSession = []; EL.input.value = ''; return;
            }

            if (lowerText === '/ritual') {
                const ritualArt = `                                                                                  
                                                                 ██                                                                              
                                                                  ███                                                                             
                                                                   ███   ███                                                                      
                                                                    ███████                                                                       
                                                                     ██████                                                                       
                                                                      ████                                                                        
                                                                     ██████                                                                       
                                                                  ███████████                                                                     
                                                        █  ███  █████████████   ███    █                                                          
                                                  █  █████  ████ █████   █████  ████  ████                                                        
                                                 █████████ ██████████     ██████████ ███  █████                                                   
                                             ████ ██    █ ████████████████████████████     ██   ███                                               
                                        ███ █████   ██████████████████████████████████████    ██████                                              
                                       █████    ███████████  █████   ██  █    █████   ██████████  █  ████                                         
                                    █████    ████████ ██  ███████     ████     ███████      ███████  ██████                                       
                                  █ ███  ████████ ██ ███████████       █        ███████        ███████  ██ █████                                  
                               ████    ███████  ████  █████████████████████████████████  ██████   ███████  █ ██                                   
                              █████ ██████   ████████ ████████████████████████████████████████ ███ █ ██████  ██████                               
                           ████   ████████  ███   █████████████████  ███████████ ████████████ ██ ██ ██  █████  ████                               
                            ███ █████   ██      ██████  ██████████  █████████ ███   ███████████  █████     ███████   █                            
                       ████   ██████  ██████ ██████   █████ ██████ █████████ ███     █████   ██████████  ██ ██████  █████                         
                       ███████████  █████ ██████     █████    █   ███████████  ████   █████     █████   █████ █████ █   ██                        
                    ███ ██  ████   ████ █████       ████████████ ███ ████ ████████      ████      █████████ ██ ██████████                         
                   ██████ █████       ██████       ████   █ ██  ████ ████  ████ ███      ████       █████ ████   █████ █                          
                  ██     ████  ████ ██████       █████ ████ █  ██████████   ████ █████   █████       █████    ███ █████  ██ █                     
                  █████ ████ █ █ █ ███████      █████ ███████████    ████    █████████     ████       ██████ ████   ████ █ ███                    
                  ███  ████  ████ ███████      █████   ████ ████     ██████   ████ █  █     █████      ███████    █  █████ ███                    
                     █████      █████████     █████ █████  █████     ████ ███   ███ █████    █████     ███ ████ █████ ████  ████                  
              ███████████████  ████  ███     █████   ████ █████      ████   ██   ███ ███      ████      ███ ████████ █ ████ ████                  
              ████  ████ █  █ ████  ████    █████ ████   █████       ████   █████ ███ ██████   ████     ████  ████████  ████  ███                 
                ██ ████ █████████  ████    █████   ████ █████        ████  ███████ ██████       █████    ████  ████      ████████                 
            ██     ████  ███████   ████   ████    █    █████         ████  ███████  ████ ████    █████   ████  ████  ███ █████  ██                
            █████ ████ ███  ███   ████   █████  ████  ████           ████    ████    ████ ████    █████  █████  ███ ███ █ ████ █████              
              █  ████   ██ ███    ████  █████  █████ ████            ████       ██    ████    █    █████ █████  ████      █████                   
           █████ ████  ██  ██    █████  ████ ████   ████              ███       ██     ██████████    █████████   ████ ███ █████ ████              
           █████ ███       ██    ██████████  █████ ██████            ████       ██       ██████      █████ ████  ██████    ████ ████              
           █  ██████  ███ ███    █  ██████        ██████████         ████       ██ ██    ████   ███   ██████ ██   ████ ███ ████ ██ █              
          █████ ████ ████████    █  █████ ██████ ████    █████       ████      ██   ██     ███ ███     █████ ██   █████████ ███ █████             
           █████████  ██████     █ █████   ███  ████       █████     ████      ████████     ███     █   ███████   ████      ████ █████            
            ██  ███   █  ███     █████  ████ █ ██████        ██      ████     ███   ████████████  ████   ██████    ███ ███  ████ █                
          ███ █ ███ ████ ███     ████  ██████ ████   ███       ██    ████    ███████████ ███████████  █   █████    ███ ████ ████ ████             
           ███  ███ ██   ███    ████   ███   ████      ██       ██    ███   ███████  ██  ██    █████████    ████   ███   █  ███████ ██            
            █   ███  ███████   ████    ███  ████        ██       █    ███  ██████   ██  ███     ███████      ████  ███ ████ ████                  
           ███  ████  ██ ███ █████   █     ████          ██       ███ ███████████  ██  ███       ████ ████    ████ ████████ ████ ████             
              █ ████  ███████████  █████  ███             ██      ███ ███   ██   ██████           █████████    ███████      ██████████            
          █████ ████ ███████████  ██     ████             ██       ██ ███  ███ ███                 ████ ██      █████████   ███   █               
           ████ ████ ██████████   █████ ████               ██      ██ ███  ████                     █████████    ████████   ███                   
                 █████████████  ███    █████  ███  ██      ██     ███████████                       █████ █████  █████████ ████ ███               
           ███ ██████ █████████ ████  ████   ██  █  ██     █      ███████  ███                      ██████████   █████████ █████████              
            ██ █ ██████████████  █   ████    ██  ██ ██    ██      ██  ███   ██                     ███  ███    ██████████ ████                    
                  █████████ █████   ████      ███████    ██      ███ ████   ████                 █████  ███████████  ██████████████               
              ███ ████████   ███  ██████        ██      ██      ███  ████     ████             █████     ████  ████   ███████ █ ███               
             ███   ██████    ████████  ██      ███      ████   ███   ████      █████████ █ ██████████████████████      █████ ██ █                 
              ██████████       █████████████████████████████████████████████████████████████████████████████████  ███   ██████████                
                █████████   ██  ███████████ ██████████   ██████████████████████████                         ███  █████  ███████                   
                 █████████ █████ ████  ███ █ ███    █    █   █  ████ ████ █  ██   ██   ██   ███ ████████ ███████████████████████                  
                █████ ████████    ████ ████ ██████  ████████████████████████  ███████  ███  ███ ████ █████████    █  ████  ██████                 
               █████    ████       █████ ██ █████  ███  ███ ██ █  █  ██████ ████ ██   ████   ██  ██   ██████       █████   ███████                
              ████████████████████████████████████████████████████████████ ███████████████████████████████████████████████████████                
       ████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████       
            ██████████████ ████████████████████████████ ██████████ ██████████████████            ██████ █████████████████       ███████           
            ███        █████ █████   ███████████             ████ ██ ████  ████ █              ██████  ████  ██████ █████        █████            
           ███           ████  █████ █████ ████████          ████ ██ ████  ████ █           ██████  ████    ██████   ██           ████            
          █         ██     █     █████     ████████████        ███ ████████████         ███████  ████ █   █████  ████               ██            
                      ██     ████  █████  ███   █   ██████████  ███  ████  ████   █████████ █████ ███   █████ ███  ██                             
                       ███    █████  ██████   ████   █  ███████████████████████████████ █████████    ██████   ███        ██                       
                         ███  ██   ██  ███████  ██  ███ ███   ███████████████████   ███  ████ █   ██████  ███ █ ██   ████                         
                          █████  █████    ████████   █ ████ █████ ██ ████  ██  ███  ███   █   ████████    ████     ████                           
                            █████       ███  █████████      ███   ███████████   ██  █    █████████   ██████     █████                             
                              ██████ ████  ███   ██████████        █ ████   █      ███████████   ██████████  ██████                               
                                ███████    ████  █    █████████████████████████████████████ ██   ████  █  ███████                                 
                                   ███████ ███ █████ ██   ██████████████████████████    ██ ██████  ██   ██████                                    
                                      ███████  ████  ███ ███  █      ████       █████   ████████    ███████                                       
                                         ██████     ████ ███ ████████████  ████ █████    ██     ████████                                          
                                             ███████     █  ████   ███████ ███  █  █       ██████████                                             
                                                █████████████        ████           █████████████                                                 
                                                     ██████████████████████████████████████ █                                                     
                                                              ███████████████████████
                `;
                const div = document.createElement('div');
                div.className = 'message bot';
                div.innerHTML = `<div style="color: #bd00ff"><div class="ascii-art">${ritualArt}</div><span>DETECTADO SINAL DE O.P. EM ALTA FREQUÊNCIA.</span></div>`;
                EL.msgs.appendChild(div);
                EL.msgs.scrollTop = EL.msgs.scrollHeight;
                EL.input.value = '';
                return;
            }

            if (lowerText === '/membrana') {
                const estado = calculateMembrane();
                const msg = `ANÁLISE ESTRUTURAL DA REALIDADE:<br>HORÁRIO LOCAL: ${new Date().toLocaleTimeString()}<br>STATUS: [ ${estado.status} ]<br>OBS: ${estado.log}<br>DIAGNÓSTICO: ${estado.msg}`;
                const div = document.createElement('div');
                div.className = 'message bot';
                div.innerHTML = `<div style="color: ${estado.cor}; text-shadow: 0 0 5px ${estado.cor}">${formatText(msg)}</div>`;
                EL.msgs.appendChild(div);
                EL.msgs.scrollTop = EL.msgs.scrollHeight;
                EL.input.value = '';
                return;
            }

            if (text.toLowerCase() === '/d20') {
                const roll = Math.floor(Math.random() * 20) + 1;
                renderMsgHTML(`🎲 DADO D20: [ ${roll} ]`, 'bot');
                EL.input.value = '';
                return;
            }

            if (lowerText === '/nex') {
                const nex = Math.floor(Math.random() * 99) + 1;
                let classe = "MUNDANO"; let cor = "#00ff41";
                if (nex > 10) { classe = "INICIADO"; cor = "#ffff00"; }
                if (nex > 45) { classe = "AGENTE EXPERIENTE"; cor = "#ffaa00"; }
                if (nex > 80) { classe = "AGENTE DE ELITE"; cor = "#ff0000"; }
                if (nex === 99) { classe = "CALAMIDADE"; cor = "#ffffff"; }

                const div = document.createElement('div');
                div.className = 'message bot';
                div.innerHTML = `<div style="color: ${cor}">CALCULANDO EXPOSIÇÃO PARANORMAL...<br>NEX ATUAL: [ ${nex}% ]<br>CLASSIFICAÇÃO: ${classe}</div>`;
                EL.msgs.appendChild(div);
                EL.msgs.scrollTop = EL.msgs.scrollHeight;
                EL.input.value = '';
                return;
            }
            
            if (lowerText === '/credits' || lowerText === '/creditos') {
                const creditsContent = `
                <div style="border: 1px dashed #00ffff; padding: 15px; background: rgba(0, 20, 20, 0.5); color: #00ffff; text-shadow: 0 0 5px #00ffff;">
                    <div style="text-align: center; font-weight: bold; margin-bottom: 10px; letter-spacing: 2px;">/// CRÉDITOS DO SISTEMA ///</div>
                    <br>
                    <strong>OPERADOR/DEV:</strong> Agente Ricardo de Castro
                    <br>
                    <strong>VERSÃO:</strong> C.R.I.S. v2.0.4
                    <br>
                    <strong>BASE DE DADOS:</strong> Ordem Paranormal Wiki
                    <br>
                    <strong>MOTOR NEURAL:</strong> DeepSeek-V3 via SiliconFlow
                    <br>
                    <strong>INSPIRAÇÃO:</strong> Universo de Ordem Paranormal (Cellbit)
                    <br><br>
                    <div style="font-style: italic; opacity: 0.8; text-align: center;">
                        "O paranormal não vem para a nossa realidade de maneira fácil."
                    </div>
                    <br>
                    <div style="text-align: center;">--- FIM DO ARQUIVO ---</div>
                </div>`;
                const div = document.createElement('div');
                div.className = 'message bot';
                div.innerHTML = `<span>${creditsContent}</span>`;
                EL.msgs.appendChild(div);
                EL.msgs.scrollTop = EL.msgs.scrollHeight;
                EL.input.value = '';
                return;
            }

            // --- LÓGICA DE SHUTDOWN (MODIFICADA) ---
            if (lowerText === '/shutdown' || lowerText === '/exit') {
                renderMsgHTML("ENCERRANDO SESSÃO...", 'bot');
                renderMsgHTML("DESCONECTANDO DA MEMBRANA...", 'bot');
                setTimeout(() => {
                    if(typeof startupAudio !== 'undefined') startupAudio.pause();
                    document.body.classList.add('shutdown-mode');
                    
                    sysConfig.status = 'shutdown';
                    saveSysConfig();
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                }, 1500);
                EL.input.value = '';
                return;
            }

            // --- MENSAGEM PADRÃO ---
            renderMsgHTML(text, 'user');
            currentSession.push({ sender: 'user', text });
            saveStorage();
            renderHistoryList();
            
            EL.input.value = '';
            toggleInput(false);

            const stopSpinner = showCliSpinner();

            activeTyperId++;
            const currentId = activeTyperId;
            charQueue = [];
            const fullTextObj = { val: "" };
            let firstChunk = true;
            let botSpan = null;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                });

                if (!response.ok) throw new Error("Falha na conexão.");
                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    
                    if (firstChunk) { 
                        stopSpinner(); // Remove spinner quando começa a responder
                        botSpan = renderMsgHTML("", 'bot'); 
                        firstChunk = false; 
                    }

                    for (const char of chunk) charQueue.push(char);
                    if (!isProcessingQueue) processQueue(botSpan, fullTextObj, currentId);
                }
            } catch (err) {
                stopSpinner();
                renderMsgHTML("<span style='color:var(--sangue)'>[ERRO CRÍTICO]: SERVIDOR INACESSÍVEL.</span>", 'bot');
                toggleInput(true);
            }
        }

        EL.btn.onclick = handleSend;
        EL.input.onkeypress = (e) => { if(e.key === 'Enter') handleSend(); };
        
        // CORREÇÃO FINAL: Se não existir sessão atual, cria uma. Se existir, apenas carrega dados.
        // O switchToSession visual já foi chamado no window.onload se estiver active.
        if (!storageData.sessions[storageData.currentId]) {
            startNewSession();
        } else {
            currentSession = storageData.sessions[storageData.currentId];
        }

    </script>
</body>
</html>